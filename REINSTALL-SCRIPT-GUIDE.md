# 生成重装脚本功能说明

## 什么是"生成重装脚本"？

"生成重装脚本"是 server-toolkit 的一个功能，用于**自动生成服务器操作系统重装脚本**。

## 使用场景

### 什么时候需要重装服务器？

1. **更换操作系统**
   - 从 Ubuntu 切换到 Debian
   - 从 CentOS 切换到 Rocky Linux
   - 升级到新的操作系统版本

2. **清理系统**
   - 系统被污染或配置混乱
   - 需要从头开始配置
   - 清除所有旧数据和配置

3. **标准化部署**
   - 批量部署多台服务器
   - 使用统一的操作系统版本
   - 自动化配置流程

## 功能说明

### 这个功能做什么？

1. **收集当前系统信息**
   - 操作系统类型和版本
   - 硬件架构（x86_64、aarch64 等）
   - 网络接口和 IP 地址
   - 主机名和 DNS 配置

2. **生成重装脚本**
   - 创建一个可执行的 bash 脚本
   - 包含系统信息和重装步骤
   - 提供安全确认机制
   - 集成重装工具下载

3. **创建重装指南**
   - 详细的重装前准备清单
   - 重装步骤说明
   - 重装后配置指南
   - 注意事项和支持信息

## 生成的文件

### 1. 重装脚本
**文件名**: `reinstall-system-YYYYMMDD_HHMMSS.sh`

**内容**：
```bash
#!/usr/bin/env bash
# Automated System Reinstall Script
# Generated by Server Toolkit

# 包含：
# - 系统信息（OS、架构、网络）
# - 安全确认机制
# - 重装工具下载
# - 重装执行命令（需要自定义）
```

### 2. 重装指南
**文件名**: `reinstall-system-YYYYMMDD_HHMMSS-GUIDE.txt`

**内容**：
- 重装前准备清单
- 重装步骤说明
- 重装后配置指南
- server-toolkit 使用说明

## 使用步骤

### 步骤 1：生成重装脚本

在 server-toolkit 主菜单中选择：
```
🔧 重装前工具
  [4] 生成重装脚本
```

或直接运行：
```bash
curl -fsSL https://raw.githubusercontent.com/k3s-forge/server-toolkit/main/pre-reinstall/prepare-reinstall.sh | bash
```

### 步骤 2：查看生成的文件

脚本会生成两个文件：
```bash
# 重装脚本
~/reinstall-system-20241230_144736.sh

# 重装指南
~/reinstall-system-20241230_144736-GUIDE.txt
```

### 步骤 3：自定义重装脚本

**重要**：必须编辑脚本，指定要安装的操作系统！

打开脚本：
```bash
nano ~/reinstall-system-20241230_144736.sh
```

找到这一行：
```bash
# Uncomment and customize the following line:
# bash /tmp/reinstall.sh debian 12
```

修改为你想要的操作系统：
```bash
# 示例 1：安装 Debian 12
bash /tmp/reinstall.sh debian 12

# 示例 2：安装 Ubuntu 22.04
bash /tmp/reinstall.sh ubuntu 22.04

# 示例 3：安装 Rocky Linux 9
bash /tmp/reinstall.sh rocky 9

# 示例 4：安装 Alpine Linux
bash /tmp/reinstall.sh alpine
```

### 步骤 4：重装前准备

**必须完成以下准备**：

1. ✅ **备份所有重要数据**
   - 数据库
   - 配置文件
   - 用户数据
   - SSH 密钥

2. ✅ **记录网络配置**
   - IP 地址
   - 网关
   - DNS 服务器
   - 网络接口名称

3. ✅ **记录服务配置**
   - 运行的服务列表
   - 配置文件位置
   - 端口映射
   - 防火墙规则

4. ✅ **确保有控制台访问**
   - IPMI
   - KVM
   - VNC
   - 物理访问

5. ✅ **测试环境验证**
   - 先在测试服务器上验证
   - 确认重装流程正常
   - 验证网络连接

### 步骤 5：执行重装

**警告**：这将删除所有数据！

```bash
# 运行重装脚本
bash ~/reinstall-system-20241230_144736.sh
```

脚本会：
1. 显示系统信息
2. 要求确认（输入 y）
3. 要求二次确认（输入 REINSTALL）
4. 下载重装工具
5. 执行重装（如果已取消注释）

### 步骤 6：等待重装完成

- 重装过程需要 5-30 分钟
- 系统会自动重启
- 不要中断重装过程
- 通过控制台监控进度

### 步骤 7：重装后配置

重装完成后，使用 server-toolkit 配置新系统：

```bash
# 下载 server-toolkit
curl -fsSL https://raw.githubusercontent.com/k3s-forge/server-toolkit/main/bootstrap.sh | bash
```

然后依次配置：
1. **基础配置**
   - [5] 基础配置 → [1] 配置 IP 地址
   - [5] 基础配置 → [2] 配置主机名
   - [5] 基础配置 → [3] 配置 DNS

2. **网络配置**
   - [6] 网络配置 → [1] 配置 Tailscale
   - [6] 网络配置 → [2] 网络优化

3. **系统配置**
   - [7] 系统配置 → [1] 配置时间同步
   - [7] 系统配置 → [2] 系统优化
   - [7] 系统配置 → [3] 安全加固

4. **K3s 部署**（可选）
   - [8] K3s 部署 → [1] 部署 K3s
   - [8] K3s 部署 → [2] 配置升级控制器
   - [8] K3s 部署 → [3] 部署存储

## 重装工具说明

### 使用的重装工具

脚本使用 [bin456789/reinstall](https://github.com/bin456789/reinstall) 项目：

**特点**：
- ✅ 支持多种 Linux 发行版
- ✅ 支持 BIOS 和 UEFI
- ✅ 支持 IPv4 和 IPv6
- ✅ 自动配置网络
- ✅ 无需 VNC/KVM（但建议有）

**支持的操作系统**：
- Debian 10/11/12
- Ubuntu 20.04/22.04/24.04
- CentOS 7/8/9 Stream
- Rocky Linux 8/9
- AlmaLinux 8/9
- Fedora 38/39/40
- Alpine Linux
- Arch Linux
- openSUSE Leap

### 重装命令示例

```bash
# Debian 12
bash /tmp/reinstall.sh debian 12

# Ubuntu 22.04
bash /tmp/reinstall.sh ubuntu 22.04

# Rocky Linux 9
bash /tmp/reinstall.sh rocky 9

# Alpine Linux (最新版)
bash /tmp/reinstall.sh alpine

# Arch Linux
bash /tmp/reinstall.sh arch

# 指定镜像源
bash /tmp/reinstall.sh debian 12 --mirror https://mirrors.tuna.tsinghua.edu.cn/debian/

# 指定密码
bash /tmp/reinstall.sh debian 12 --password 'YourPassword'

# 指定 SSH 端口
bash /tmp/reinstall.sh debian 12 --ssh-port 2222
```

## 安全注意事项

### ⚠️ 重要警告

1. **数据丢失**
   - 重装会删除所有数据
   - 必须提前备份
   - 无法恢复

2. **网络中断**
   - 重装过程中会断网
   - 需要控制台访问
   - 可能需要重新配置网络

3. **服务中断**
   - 所有服务会停止
   - 需要重新安装和配置
   - 提前通知用户

4. **测试验证**
   - 先在测试环境验证
   - 确认流程正常
   - 准备回滚方案

### ✅ 最佳实践

1. **完整备份**
   ```bash
   # 备份重要目录
   tar -czf backup-$(date +%Y%m%d).tar.gz /etc /home /root /var/www
   
   # 上传到远程
   scp backup-*.tar.gz user@backup-server:/backups/
   ```

2. **记录配置**
   ```bash
   # 导出网络配置
   ip addr > network-config.txt
   ip route >> network-config.txt
   
   # 导出服务列表
   systemctl list-units --type=service --state=running > services.txt
   
   # 导出软件包列表
   dpkg -l > packages.txt  # Debian/Ubuntu
   rpm -qa > packages.txt  # CentOS/Rocky
   ```

3. **保存密钥**
   ```bash
   # 备份 SSH 密钥
   cp -r ~/.ssh ~/ssh-backup
   cp -r /etc/ssh /root/ssh-config-backup
   ```

4. **测试连接**
   ```bash
   # 确保有控制台访问
   # 测试 IPMI/KVM 连接
   # 准备备用访问方式
   ```

## 常见问题

### Q1: 重装会保留数据吗？
**A**: 不会！重装会删除所有数据。必须提前备份。

### Q2: 重装需要多长时间？
**A**: 通常 5-30 分钟，取决于网络速度和服务器性能。

### Q3: 重装失败怎么办？
**A**: 
- 通过控制台（IPMI/KVM）访问
- 检查网络连接
- 查看重装日志
- 联系服务器提供商

### Q4: 可以远程重装吗？
**A**: 可以，但强烈建议有控制台访问，以防网络配置失败。

### Q5: 重装后 IP 地址会变吗？
**A**: 通常不会，但需要在重装后验证并重新配置。

### Q6: 支持哪些操作系统？
**A**: 支持主流 Linux 发行版，详见"重装工具说明"部分。

### Q7: 需要什么权限？
**A**: 需要 root 权限。

### Q8: 可以自定义分区吗？
**A**: 重装工具使用默认分区方案。如需自定义，请查看工具文档。

## 相关文档

- [README.md](README.md) - 项目主文档
- [README.zh.md](README.zh.md) - 中文主文档
- [LANGUAGE-SELECTION-UPDATE.md](LANGUAGE-SELECTION-UPDATE.md) - 语言选择更新
- [bin456789/reinstall](https://github.com/bin456789/reinstall) - 重装工具文档

## 支持

- **文档**: https://github.com/k3s-forge/server-toolkit
- **问题反馈**: https://github.com/k3s-forge/server-toolkit/issues
- **讨论**: https://github.com/k3s-forge/server-toolkit/discussions

---

**更新日期**: 2024-12-30  
**版本**: 1.0.2  
**状态**: ✅ 功能正常

**警告**：重装操作系统是高风险操作，请务必做好备份和准备工作！

